<!DOCTYPE html>
<html>
<head>
    <title>Friends Talk</title>
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>
    <div>
        <div class="modal fade" id="usernameModal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-body row">
                <form id="usernameForm">
                    <div class="col-xs-12 col-sm-9">
                        <input class="form-control" type="text" name="something" id="username" placeholder="Enter a Username">    
                    </div>
                    <div class="col-xs-12 col-sm-3">
                        <button id="modalControl" type="button" class="btn btn-primary">Start Chatting!</button>
                    </div>
                </form>
              </div>
                <p class="error-msg"></p>    
             
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <h1 class="center">Friends Talk</h1><br><br>
        <div id="chatBox">
            
            
        </div><br><br>
        <form id="messageForm">
                <span id="userTyping"></span>
                <input id="message" type="text" name="message">
        </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.js"></script>
    <script type="text/javascript">
        
        

        $(() => {
            // initialize socket
            var socket = io();
            
            var currentUser = '';
            var chatColors = [
                '#F44336',
                '#673AB7',
                '#EF6C00',
                '#795548',
                '#607D8B',
                '#004D40',
                '#880E4F',
                '#FFC107',
                '#03A9F4',
                '#1A237E'
            ];
            var colorCount = 1;
            var users = [];

            // Modal Controls
            $("#usernameModal").modal({
                backdrop: 'static',
                keyboard: false
            });
            $('#usernameModal').on('shown.bs.modal', function () {
                $('#username').focus()
            });
            $("#usernameModal").modal('show');

            // Check that username is not empty
            $("#usernameForm").submit((e) => {
                e.preventDefault();

                let username = $("#username").val();
                if (username == '') {
                    $(".error-msg").html("You must enter a username!");
                }
                else {
                    currentUser = username;
                    users.push(currentUser);
                    $("#usernameModal").modal('hide');
                    $("#message").focus();

                    socket.emit("join", currentUser);
                }
            
            });
                
            // template for chat message
            function messageTemplate(username, user, msg, color) {

                let tag = "<div class='chatMessage " + user +"'>" + 
                "<h3 style='color:" + color + "'>" + username +" </h3>" + "<p>" + msg + "</p></div>";
                return tag;
            }

            function joinTemplate(username) {
                let tag = "<p class='center join'>"+ username +" joined the chat.</p>";
                return tag;
            }


            $("#messageForm").submit((e) => {
                e.preventDefault();

                // send message to other users
                let user = currentUser;
                let message = $("#message").val();
                let msg = {"user": user, "message": message};
                socket.emit('msg', msg);

                $("#message").val('');

                // set chat color
                let index = users.indexOf(user);
                if (index == -1) {
                    users.push(user);
                    index = colorCount % chatColors.length;
                    colorCount += 1;
                }

                $(messageTemplate(currentUser, 'currentUser', message, chatColors[index])).appendTo("#chatBox");
                
                var chatBox = document.getElementById("chatBox");
                chatBox.scrollTop = chatBox.scrollHeight;
                return false;
            });



            $("#message").on('keypress', () => {
                socket.emit('userTyping', currentUser);
            });


            socket.on('msg', (msg) => {
                // set chat color
                let index = users.indexOf(msg.user);
                if (index == -1) {
                    users.push(msg.user);
                    index = colorCount % chatColors.length;
                    colorCount += 1;
                }
                $(messageTemplate(msg.user, 'otherUser', msg.message, chatColors[index])).appendTo("#chatBox");
                
                var chatBox = document.getElementById("chatBox");
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            socket.on('userTyping', (username) => {
                $("#userTyping").html(username + " is typing...");
                var timeout = setTimeout(() => {
                    $("#userTyping").html('');
                }, 1000);

                function calledAgain() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        $("#userTyping").html('');
                    }, 1000);
                }
                calledAgain();
            });

            socket.on('join', (username) => {
                $(joinTemplate(username)).appendTo("#chatBox");
            });

        });
    </script>
</body>
</html>